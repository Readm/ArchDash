# ArchDash 累计绘图功能实施总结

## 功能概述

在相关性分析卡片中新增了"累计绘图"功能，允许用户在同一图表中累积显示多次生成的参数敏感性分析曲线。

## 实施的功能特性

### ✅ 用户界面改进

#### 1. 累计绘图复选框
- **位置**: 相关性分析卡片中，参数范围设置区域下方（左侧）
- **功能**: 用户可以勾选"累计绘图"选项
- **标签**: "累计绘图"
- **说明文本**: "选中后，每次生成的点会累积在图表中"

#### 2. 系列名称输入框 🆕
- **位置**: 与累计绘图复选框同行，系列名称在左侧（8列），累计绘图在右侧（4列）
- **功能**: 用户可以自定义每次生成的系列名称
- **标签**: "系列名称:"
- **占位符**: "自定义系列名称"
- **说明文本**: "留空则使用默认名称"
- **默认行为**: Y轴参数改变时自动填充默认名称
- **布局优化**: 📍 累计绘图复选框右对齐，界面更加紧凑美观

#### 3. 视觉反馈
- **标题显示**: 启用累计模式时，图表标题显示为"参数敏感性分析（累计模式）"
- **状态显示**: 输出结果显示累计曲线数量，如"(累计: 3 条曲线)"
- **图例显示**: 📍 **优化**：始终显示图例，方便用户区分不同曲线
- **图例布局**: 垂直布局，位置在图表右侧（x=1.02），不遮挡图表内容

### ✅ 数据存储和管理

#### 1. 累计数据存储
- **组件**: `dcc.Store(id="cumulative-plot-data")`
- **数据结构**: 列表，每个元素包含一条曲线的完整信息
- **存储限制**: 最多保存10条曲线，防止内存溢出

#### 2. 数据结构设计
```python
current_trace_data = {
    'x_values': result['x_values'],           # X轴数据点
    'y_values': result['y_values'],           # Y轴数据点
    'x_label': result['x_label'],             # X轴标签
    'y_label': result['y_label'],             # Y轴标签
    'trace_name': f"{y_param_info['label']}", # 曲线名称
    'x_param': x_param,                       # X轴参数标识
    'y_param': y_param,                       # Y轴参数标识
    'timestamp': datetime.now().isoformat()   # 生成时间戳
}
```

### ✅ 图表渲染逻辑

#### 1. 历史曲线显示
- **颜色系统**: 使用8种不同颜色循环显示
- **透明度递减**: 历史曲线逐渐变淡 `color_alpha = max(0.3, 1.0 - i * 0.1)`
- **线条样式**: 历史曲线使用较细线条(width=1.5)和较小标记点(size=4)
- **命名规则**: 历史曲线标记为"(历史)"，当前曲线标记为"(当前)"

#### 2. 当前曲线显示
- **突出显示**: 当前曲线使用标准线条宽度(width=2)和标记点大小(size=6)
- **颜色**: 始终使用主色调('#1f77b4')
- **图例**: 清晰标识为"(当前)"

### ✅ 回调函数改进

#### 1. 自动更新系列名称回调函数 🆕
```python
@callback(
    Output("series-name-input", "value"),
    Input("y-param-selector", "value"),
    prevent_initial_call=True
)
def auto_update_series_name(y_param):
    """当Y轴参数改变时，自动设置系列名称为该参数的标签"""
    if not y_param:
        return ""
    
    try:
        # 从参数值中解析节点ID和参数名
        y_node_id, y_param_name = y_param.split('|')
        
        # 从graph中获取节点
        y_node = graph.nodes.get(y_node_id)
        if not y_node:
            return ""
        
        # 构建默认系列名称
        default_name = f"{y_node.name}.{y_param_name}"
        return default_name
        
    except (ValueError, AttributeError):
        return ""
```

#### 2. 生成图表回调函数增强
```python
@callback(
    Output("sensitivity-plot", "figure", allow_duplicate=True),
    Output("output-result", "children", allow_duplicate=True),
    Output("cumulative-plot-data", "data", allow_duplicate=True),  # 新增
    Input("generate-plot-btn", "n_clicks"),
    State("x-param-selector", "value"),
    State("y-param-selector", "value"),
    State("x-start-value", "value"),
    State("x-end-value", "value"),
    State("x-step-value", "value"),
    State("cumulative-plot-checkbox", "value"),                   # 新增
    State("cumulative-plot-data", "data"),                        # 新增
    State("series-name-input", "value"),                         # 🆕 新增
    prevent_initial_call=True
)
```

#### 3. 清除图表回调函数增强
```python
@callback(
    Output("sensitivity-plot", "figure", allow_duplicate=True),
    Output("x-param-selector", "value"),
    Output("y-param-selector", "value"),
    Output("cumulative-plot-data", "data", allow_duplicate=True), # 新增
    Input("clear-plot-btn", "n_clicks"),
    prevent_initial_call=True
)
```

### ✅ 累计模式逻辑

#### 1. 模式检测
```python
is_cumulative = "cumulative" in (cumulative_checkbox or [])
```

#### 2. 系列命名逻辑 🆕
```python
# 确定系列名称：优先使用用户自定义名称，否则使用默认名称
final_series_name = series_name.strip() if series_name and series_name.strip() else f"{y_param_info['label']}"
```

#### 3. 数据累积流程
1. **检查累计模式**: 判断用户是否勾选累计绘图
2. **确定系列名称**: 优先使用自定义名称，否则使用默认名称 🆕
3. **加载历史数据**: 如果启用累计且有历史数据，先绘制历史曲线
4. **添加当前数据**: 绘制当前分析的曲线（使用确定的系列名称）
5. **更新存储**: 将当前数据添加到累计存储中
6. **限制管理**: 确保存储数据不超过10条曲线

#### 4. 清除机制
- **完全清除**: 点击清除按钮会同时清除图表、参数选择器和累计数据
- **返回值**: `return create_empty_plot(), None, None, []`

## 🎯 用户使用流程

### 基本使用步骤
1. **启动应用**: 运行ArchDash应用
2. **创建计算图**: 在左侧创建节点和参数，建立依赖关系
3. **开启累计模式**: 在右侧相关性分析卡片中勾选"累计绘图"复选框
4. **选择参数**: 分别选择X轴和Y轴参数
5. **自定义系列名称**: 在系列名称输入框中输入自定义名称（可选）🆕
6. **设置范围**: 配置X轴参数的起始值、结束值和步长
7. **生成第一条曲线**: 点击"生成"按钮
8. **更改参数或名称**: 选择不同的参数组合、调整范围或修改系列名称 🆕
9. **生成更多曲线**: 再次点击"生成"按钮，新曲线会叠加显示
10. **清除数据**: 需要重新开始时点击"清除"按钮

### 高级使用技巧
- **参数对比**: 保持X轴参数不变，更改Y轴参数，观察不同输出的响应
- **范围对比**: 保持参数不变，使用不同的分析范围
- **混合分析**: 交替更改X轴和Y轴参数，建立复杂的关系图
- **命名策略**: 使用有意义的系列名称，如"方案A"、"优化前"、"高温条件"等 🆕
- **版本对比**: 为不同设计版本使用不同的系列名称进行对比分析 🆕

## 🔧 技术实现细节

### 性能优化
- **数据限制**: 最多保存10条曲线，自动删除最旧的数据
- **内存管理**: 使用列表切片 `new_cumulative_data[-10:]` 高效管理数据
- **渲染优化**: 历史曲线使用较小的标记点和透明度减少渲染负担
- **显示优化**: 正常模式隐藏图例减少视觉干扰，放大模式显示图例提供详细信息

### 错误处理
- **空值检查**: 安全处理 `cumulative_checkbox or []`
- **数据验证**: 确保累计数据结构完整性
- **回退机制**: 出错时返回原始累计数据

### 兼容性
- **向后兼容**: 未勾选累计模式时行为与原来完全一致
- **数据格式**: 累计数据使用标准JSON可序列化格式
- **浏览器支持**: 利用Dash的标准组件确保跨浏览器兼容

## 📊 示例应用场景

### 1. 多参数敏感性对比
- 固定X轴为"温度"，分别分析"压力"、"体积"、"密度"的响应
- 在同一图表中对比这些参数对温度变化的敏感程度

### 2. 范围敏感性分析
- 固定参数组合，使用不同的分析范围(0-50, 50-100, 100-150)
- 观察参数在不同区间的响应特性

### 3. 设计优化迭代
- 在设计过程中，保留每次修改后的参数响应曲线
- 追踪设计演进过程，对比优化效果

## 🚀 未来增强可能

### 潜在功能扩展
1. **曲线标注**: 为每条曲线添加自定义标签
2. **数据导出**: 支持导出累计数据到文件
3. **曲线管理**: 允许选择性删除特定历史曲线
4. **配色方案**: 提供多种颜色主题选择
5. **统计分析**: 添加累计曲线的统计对比功能

### 性能优化方向
1. **懒加载**: 大量历史数据的按需渲染
2. **压缩存储**: 优化累计数据的存储格式
3. **缓存机制**: 智能缓存避免重复计算

## 📝 总结

累计绘图功能成功集成到ArchDash的相关性分析模块中，提供了强大的多曲线对比能力。该功能在保持原有用户体验的基础上，显著增强了参数分析的深度和广度，特别适用于需要对比多种参数组合或追踪设计演进过程的场景。

### 🆕 界面布局优化 

最新版本进行了**界面布局优化**，提升了用户体验：

#### 布局改进
- **一行布局**: 系列名称输入框与累计绘图复选框放在同一行
- **空间分配**: 系列名称占8列（左侧），累计绘图占4列（右侧）
- **对齐优化**: 累计绘图复选框右对齐，界面更加紧凑美观
- **说明简化**: 累计绘图说明文字简化为"每次生成累积在图表中"

#### 图例显示优化
- **始终显示**: 取消了原来的"正常隐藏，放大显示"策略
- **统一体验**: 无论正常查看还是放大查看，都显示图例
- **位置优化**: 图例位于图表右侧（x=1.02），不遮挡内容

### 🆕 系列名称功能增强

版本还新增了**系列名称自定义功能**，进一步提升了用户体验：

#### 核心特性
- **智能默认值**: Y轴参数改变时自动填充默认系列名称
- **自定义输入**: 用户可输入有意义的系列名称，如"方案A"、"优化版本"等
- **灵活切换**: 留空自动使用默认名称，输入内容则使用自定义名称
- **空格处理**: 自动去除前后空格，确保名称整洁

#### 使用价值
- **提高可读性**: 使用描述性名称替代技术参数名，图表更易理解
- **版本管理**: 为不同设计方案使用不同名称，便于版本对比
- **团队协作**: 统一的命名规范提高团队沟通效率
- **报告生成**: 专业的系列名称使分析报告更加正式和清晰

这一功能进一步完善了ArchDash的参数分析能力，使其更适用于专业的工程设计和科学研究场景。

通过合理的数据管理、优雅的视觉设计和健壮的错误处理，该功能为用户提供了直观、高效的累计分析体验。 